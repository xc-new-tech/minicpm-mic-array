# MiniCPM-o 2.6 + 麦克风阵列 嘈杂环境语音对话测试

## 背景
- 应用场景：商场美妆集合店数字人产品
- 目标：测试模型在嘈杂环境下的语音对话表现
- 硬件：Apple M4 Max + 128GB RAM + 4麦克风阵列

---

## 完成进度

### 基础环境
- [x] 创建 Python 3.10 虚拟环境 (conda)
- [x] 安装 MiniCPM-o 依赖（transformers 4.44.2, torch, librosa等）
- [x] 安装麦克风阵列处理依赖（pyroomacoustics, webrtcvad）
- [x] 下载 MiniCPM-o 2.6 模型 (~16GB)

### 麦克风阵列前端处理
- [x] 实现声源定位 (DOA) - SRP-PHAT 算法
- [x] 实现波束成形 - Delay-and-Sum 算法
- [x] 实现语音活动检测 (VAD) - WebRTC VAD
- [x] 实现降噪处理 - 谱减法
- [x] 集成完整测试流程

### 人声检测与分离
- [x] 实现人声检测 - F0基频 + VAD + 频谱特征
- [x] 实现多声源定位 - 定位多个候选方向
- [x] 实现人声方向定位 - 只聚焦人声方向，过滤音乐/噪声
- [x] 集成人声分离 - Demucs (htdemucs) 模型
- [x] MiniCPM-o ASR 对比测试

---

## 测试结果

### 声源定位测试
| 真实方向 | 检测方向 | 误差 | 评价 |
|---------|---------|------|------|
| 30° | 33.6° | 3.6° | ✅ 良好 |
| 45° | 50.6° | 5.6° | ✅ 良好 |

### 语音识别对比测试
预期文本：**"你好，请推荐一款适合干皮的粉底液"**

| 场景 | 噪声级别 | 原始录音 | 处理后 | 改善 |
|------|---------|----------|--------|------|
| 轻度噪声 | 0.1 | ❌ 乱码 | ❌ 乱码 | - |
| **中度噪声** | **0.2** | ❌ 乱码 | ⚠️ 部分正确 | **有改善** |
| 重度噪声 | 0.35 | ❌ 失败 | ❌ 失败 | - |
| 极端噪声 | 0.5 | ❌ 失败 | ❌ 失败 | - |

**中度噪声处理后结果**："西点一盘适合柑橘的粉底液"（部分正确）

### 人声分离测试 (Demucs)

预期文本：**"你好，请推荐一款适合干皮的粉底液"**

| 噪声级别 | 原始录音 | 波束成形 | 人声分离(Demucs) | 评价 |
|---------|---------|---------|-----------------|------|
| **0.05 (轻度)** | ❌ 乱码 | ❌ 错误 | ✅ "皮干的话，建议使用保湿效果好的粉底液" | **有效** |
| 0.10 (中度) | ❌ | ❌ | ❌ | 失败 |
| 0.15 (重度) | ⚠️ 部分 | ❌ | ❌ | 失败 |

**关键发现**：
- 轻度噪声(0.05)下，人声分离能抓住关键词"干皮"和"粉底液"
- 噪声级别 ≥ 0.1 时，MiniCPM-o 识别能力急剧下降
- 人声分离帮助 F0 基频检测从 0 提升到 0.66

### 人声检测置信度对比

| 方法 | F0检测 | VAD比例 | 分离比 | 总置信度 |
|------|--------|--------|--------|---------|
| 无人声分离 | 0.00 | 0.99 | - | 0.47 |
| 有人声分离 | **0.66** | 0.93 | 0.69 | **0.73** |

---

## 结论

### 优点
1. **声源定位准确** - DOA 误差 < 6°，可靠定位说话者
2. **波束成形有效** - 中度噪声下识别效果有改善
3. **完整处理流程** - DOA → 波束成形 → VAD → 降噪 → ASR
4. **人声分离有效** - Demucs 在轻度噪声下显著提升识别效果
5. **人声检测准确** - F0 + VAD + 频谱特征综合判断

### 问题
1. **TTS 合成音频质量** - macOS say 命令生成的测试音频可能不够自然
2. **MiniCPM-o 噪声容忍度低** - 噪声级别 ≥ 0.1 时识别能力急剧下降
3. **人声分离计算量大** - Demucs 模型约 80MB，处理较慢

### 建议
1. **控制环境噪声** - SNR > 15dB (噪声级别 < 0.1) 效果最佳
2. **麦克风靠近用户** - 减少距离衰减，提高信噪比
3. **增加麦克风数量** - 6-8 麦克风阵列效果更好
4. **考虑专用 ASR 模型** - Whisper 等对噪声更鲁棒
5. **添加回声消除 (AEC)** - 如果有扬声器播放的场景

---

## 使用方法

```bash
# 激活环境
source /opt/miniconda3/etc/profile.d/conda.sh
conda activate /Users/xc-tech/code/minicpm/venv

# 运行基础测试
cd /Users/xc-tech/code/minicpm
python test_audio.py

# 运行麦克风阵列完整测试
python test_with_mic_array.py

# 单独测试麦克风阵列前端处理
python mic_array.py
```

---

## 文件结构
```
minicpm/
├── venv/                      # Python 3.10 虚拟环境
├── requirements.txt           # 依赖列表
├── mic_array.py              # 麦克风阵列前端处理模块
│   ├── MicArrayProcessor     # 主处理器类
│   ├── estimate_doa()        # 单声源定位
│   ├── estimate_doa_multi()  # 多声源定位
│   ├── beamform()            # 波束成形
│   ├── noise_reduce()        # 降噪
│   ├── detect_voice_activity() # VAD
│   ├── is_human_voice()      # 人声检测 (F0+VAD+频谱)
│   ├── separate_voice()      # 人声分离 (Demucs)
│   └── find_human_voice_direction() # 人声方向定位
├── test_audio.py             # 基础音频测试
├── test_with_mic_array.py    # 完整麦克风阵列+人声分离测试
├── test_input.wav            # 测试音频
├── outputs/                  # 测试输出
│   ├── mic_array_*_raw.wav         # 原始录音
│   ├── mic_array_*_traditional.wav # 传统波束成形
│   ├── mic_array_*_separated.wav   # 人声定位+波束成形
│   └── mic_array_*_vocals.wav      # 纯净人声(Demucs)
├── CLAUDE.md                 # Claude Code 项目说明
└── todo.md                   # 本文件
```

---

## 麦克风阵列处理流程

### 传统流程
```
多通道音频输入
      │
      ▼
┌─────────────────┐
│  声源定位 (DOA) │  ← SRP-PHAT 算法
│  识别最大响度   │
└────────┬────────┘
         │ 方向角
         ▼
┌─────────────────┐
│   波束成形     │  ← Delay-and-Sum
│   定向拾音     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   降噪处理     │  ← 谱减法
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  MiniCPM-o 2.6 │
│   ASR / 对话    │
└─────────────────┘
```

### 人声分离增强流程 (推荐)
```
多通道音频输入
      │
      ▼
┌─────────────────┐
│ 多声源定位     │  ← SRP-PHAT (num_src=3)
│ 候选方向1,2,3  │
└────────┬────────┘
         │
    ┌────┴────┬────────┐
    ▼         ▼        ▼
┌───────┐ ┌───────┐ ┌───────┐
│波束成形│ │波束成形│ │波束成形│
│ 方向1 │ │ 方向2 │ │ 方向3 │
└───┬───┘ └───┬───┘ └───┬───┘
    │         │        │
    ▼         ▼        ▼
┌───────┐ ┌───────┐ ┌───────┐
│Demucs │ │Demucs │ │Demucs │  ← 人声分离
│人声分离│ │人声分离│ │人声分离│
└───┬───┘ └───┬───┘ └───┬───┘
    │         │        │
    ▼         ▼        ▼
┌───────┐ ┌───────┐ ┌───────┐
│人声检测│ │人声检测│ │人声检测│  ← F0+VAD+频谱
│置信度 │ │置信度 │ │置信度 │
└───┬───┘ └───┬───┘ └───┬───┘
    │         │        │
    └────┬────┴────────┘
         │
         ▼
┌─────────────────┐
│ 选择置信度最高  │
│   的人声方向    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   降噪处理     │  ← 谱减法
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  MiniCPM-o 2.6 │
│   ASR / 对话    │
└─────────────────┘
```

---
*更新时间：2025-12-13*
